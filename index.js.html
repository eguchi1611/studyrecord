<script>
  window.app = new Vue({
    el: "#app",
    data: {
      records: {},
      tab: "",
      customRange: {
        start: "",
        end: "",
      },
      emptyDateList: [],
      suggestedElapsedTimeList: [],
      status: {},
      dateList: [],
      entryDate: "",
      elapsedHours: 0,
      elapsedMinutes: 0,
      responseMessage: "",
    },
    computed: {
      dateMin() {
        let min = this.dateList[0];
        this.customRange.start = min;
        return min;
      },
      dateMax() {
        let max = this.dateList[this.dateList.length - 1];
        this.customRange.end = max;
        return max;
      },
    },
    methods: {
      getTotalAll(className, groupName) {
        let total = 0;
        let groups = this.records[className][groupName].total;
        let keys = Object.keys(groups);
        for (let key of keys) {
          total += groups[key];
        }
        return Math.round((total / keys.length) * 10) / 10;
      },
      getTotalWeek(className, groupName) {
        let total = 0;
        let groups = this.records[className][groupName].total;
        let keys = Object.keys(groups).splice(-7, 7);
        for (let key of keys) {
          total += groups[key];
        }
        return Math.round((total / keys.length) * 10) / 10;
      },
      getTotalCustom(className, groupName) {
        let start = (new Date(this.customRange.start).getTime() - new Date(this.dateMin).getTime()) / 24 / 60 / 60 / 1000;
        let end = (new Date(this.customRange.end).getTime() - new Date(this.dateMax)) / 24 / 60 / 60 / 1000;
        let total = 0;
        let groups = this.records[className][groupName].total;
        let keys = this.dateList.slice(start, end != 0 ? end : undefined);
        for (let key of keys) {
          total += groups[key];
        }
        return Math.round((total / keys.length) * 10) / 10;
      },
      submit() {
        google.script.run
          .withSuccessHandler(function (mesage) {
            loadData();

            // メッセージ
            window.app.responseMessage = "記録しました";
            setTimeout(() => {
              window.app.responseMessage = "";
            }, 2000);
          })
          .commit(this.entryDate, Number(this.elapsedHours) + Math.round((this.elapsedMinutes / 60) * 10) / 10, this.status, this.dateList);
      },
    },
    watch: {
      tab() {
        setTimeout(tableSort, 0);
      },
      customRange: {
        handler: tableSort,
        deep: true,
      },
    },
  });

  $(loadData);

  function loadData() {
    google.script.run
      .withSuccessHandler(function (overview) {
        let app = window.app;

        // emptyDateList
        if (!overview.emptyDateList.length) {
          $("#writeModal").modal("hide");
        }
        app.emptyDateList = overview.emptyDateList;
        app.entryDate = overview.emptyDateList[0];

        // suggestedElapsedTimeList
        app.suggestedElapsedTimeList = overview.suggestedElapsedTimeList.splice(0, 3);

        // status
        app.status = overview.status;

        // dateList
        app.dateList = overview.dateList;
      })
      .getOverview();

    google.script.run
      .withSuccessHandler(function (records) {
        let app = window.app;
        app.records = records;
        app.tab = Object.keys(app.records).sort()[0];
      })
      .getRecords();
  }

  function tableSort() {
    $(".sortable_table").trigger("destroy");
    $(".sortable_table").tablesorter({
      sortList: [[1, 0]],
      headers: {
        0: { sorter: false },
      },
    });
  }
</script>
