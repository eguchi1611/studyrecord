<script>
  window.appWrite = new Vue({
    el: "#writeApp",
    data: {
      date: formatDate(),
      hour: 0,
      minute: 0,
      message: "",
      empties: [],
      suggested: [],
    },
    methods: {
      submit() {
        google.script.run
          .withSuccessHandler(function () {
            window.load();
          })
          .withFailureHandler(function (error) {
            window.appWrite.message = error.message;
          })
          .commit(this.date, this.record);
      },
    },
    computed: {
      record() {
        return Number(this.hour) + Math.round((this.minute / 60) * 10) / 10;
      },
    },
  });

  function formatDate(request) {
    let date = request || new Date();
    return date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2) + "-" + ("0" + date.getDate()).slice(-2);
  }

  window.load = function load() {
    google.script.run
      .withSuccessHandler(function (overview) {
        let empties = [];
        for (let object of overview.empties) empties.push(formatDate(new Date(object)));
        if (!empties.length) $("#writeModal").modal("hide");
        window.appWrite.empties = empties;
        let records = overview.mode;
        if (records.length >= 3) records = records.splice(0, 3);
        let suggested = [];
        for (let record of records) {
          suggested.push([(hour = Math.floor(record)), Number("0." + String(record).split(".")[1]) * 60]);
        }
        window.appWrite.suggested = suggested;
      })
      .getOverview();
  };

  $(window.load);
</script>
